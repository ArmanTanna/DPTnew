@model DPTnew.Models.DptCases

@{
    ViewBag.Title = "Case Management";
}

@section Scripts {
    @*<script src="~/Scripts/Company/table_list.js"> </script>*@
    <link href="~/Content/jquery-ui.min.css" rel="stylesheet" />
    <script src="~/Scripts/jquery-ui.min.js"></script>
    <link href="~/Content/buttons.dataTables.min.css" rel="stylesheet" />
    <link href="~/Content/jquery.dataTables.min.css" rel="stylesheet" />
    @*<script src="~/Scripts/jquery.dataTables.min.js"></script>*@
    <script src="~/Scripts/dataTables.buttons.min.js"></script>
    <script src="~/Scripts/buttons.flash.min.js"></script>
    <script src="~/Scripts/jszip.min.js"></script>
    <script src="~/Scripts/pdfmake.min.js"></script>
    <script src="~/Scripts/vfs_fonts.js"></script>
    <script src="~/Scripts/buttons.html5.min.js"></script>
    <script src="~/Scripts/buttons.print.min.js"></script>
    <script src="~/Scripts/jquery.highlight.js"></script>

    <script type="text/javascript">

        var yourApp = yourApp || {};
        yourApp.Urls = yourApp.Urls || {};
        yourApp.Urls.baseUrl = '@Url.Content("~")';
        yourApp.Urls.CaseDataUrl = '@Url.Action("NewCaseRow", "Case")';
        yourApp.Urls.ModifyDataUrl = '@Url.Action("ModifyCaseRow", "Case")';
        yourApp.Urls.CaseHistoryUrl = '@Url.Action("NewCaseHistoryRow", "Case")';
        yourApp.Urls.GetCaseHistoryUrl = '@Url.Action("CaseHistories", "Case")';

        function format(d) {
            // `d` is the original data object for the row
            return '<table cellpadding="5" cellspacing="0" border="0" width="100%" style="padding-left:50px;">' +
             '<tr>' +
                  '<td style="width:15%"><b>' + "@DPTnew.Localization.Resource.Contact" + ':</b></td>' +
                      '<td style="width:55%">' + d.Contact + '</td>' +

                     '<td style="width:15%"><b>' + "@DPTnew.Localization.Resource.Severity" + ':</b></td>' +
                      '<td style="width:15%">' + d.Severity + '</td>' +

                  '</tr>' +
                  '<tr>' +
                      '<td><b>' + "@DPTnew.Localization.Resource.Product" + ':</b></td>' +
                      '<td>' + d.Product + '</td>' +

                      '<td><b>' + "@DPTnew.Localization.Resource.Version" + ':</b></td>' +
                      '<td>' + d.ProductVersion + '</td>' +

                  '</tr>' +
                   '<tr>' +

                      '<td><b>' + "@DPTnew.Localization.Resource.Platform" + ':</b></td>' +
                      '<td>' + d.Platform + '</td>' +

                      '<td><b>' + "@DPTnew.Localization.Resource.PlatformVersion" + ':</b></td>' +
                      '<td>' + d.PlatformVersion + '</td>' +

                  '</tr>' +
                  '<tr>' +

                      '<td><b>' + "@DPTnew.Localization.Resource.Details" + ':</b></td>' +
                      '<td>' + d.Details + '</td>' +

                      '<td></td><td></td>' +

                  '</tr>' +
                  //'<tr>' +
                  //    '<td><b>File:</b></td>' +
                  //    '<td>' + (d.File ? '<a href="' + d.File.replace("E:\\Case", "T3-Case") + '">' + d.File.split("\\")[d.File.split("\\").length - 1] : "") + '</td>' +
                  //'</tr>' +
                  '</table>';
        }

        $(document).ready(function () {

            var myTable = $("#dptcase").DataTable({
                serverSide: true,
                processing: true,
                dom: 'lBfrtip',
                buttons: [
                    'csv', 'excel', 'pdf'
                ],
                ajax: {
                    type: "POST",
                    url: "Case/Search"
                },
                language: {
                    search: "@DPTnew.Localization.Resource.Search",
                    lengthMenu: "@DPTnew.Localization.Resource.lengthmenu",
                    info: "@DPTnew.Localization.Resource.info",
                    infoFiltered: "@DPTnew.Localization.Resource.infofiltered",
                    paginate: {
                        previous: "@DPTnew.Localization.Resource.Previous",
                        next: "@DPTnew.Localization.Resource.Next",
                    },
                    select: {
                        rows: {
                            0: "@DPTnew.Localization.Resource.noRowsSelected",
                            1: "@DPTnew.Localization.Resource.rowsSelected",
                        }
                    }
                },
                columns: [
                {
                    "className": 'details-control',
                    "orderable": false,
                    "data": null,
                    "defaultContent": ''
                },
                { data: "CaseId" },
                { data: "Description" },
                { data: "Type" },
                { data: "Status" },
                {
                    data: "CCEngineer",
                    render: function (data, type, row) {
                        return data ? data.split(".")[0].charAt(0).toUpperCase() + data.split(".")[0].slice(1) + " " +
                            (data.split(".")[1].indexOf("t3") == -1 ?
                            data.split(".")[1].substring(0, data.split(".")[1].indexOf("dpt") - 1).charAt(0).toUpperCase() + data.split(".")[1].substring(0, data.split(".")[1].indexOf("dpt") - 1).slice(1) :
                            data.split(".")[1].substring(0, data.split(".")[1].indexOf("t3") - 1).charAt(0).toUpperCase() + data.split(".")[1].substring(0, data.split(".")[1].indexOf("t3") - 1).slice(1)) : "";
                    }
                },
                    { data: "Language" },
                    { data: "StrModifiedOn" },
                    { data: "AccountName" }
                ],
                order: [[7, 'desc']],
                orderClasses: false,
                select: {
                    style: 'single'
                }
            });

            new $.fn.dataTable.Buttons(myTable, {
                buttons: [
             {
                 text: '@DPTnew.Localization.Resource.Modify',
                 className: 'modify',
                 action: function () {
                     if (myTable.rows('.selected').count() != 0) {
                         var data = myTable.rows('.selected').data()[0];
                         $.post(yourApp.Urls.ModifyDataUrl, {
                             CaseId: data.CaseId,
                             StrCreatedOn: data.StrCreatedOn,
                             StrModifiedOn: data.StrModifiedOn,
                             //Description: escape(data.Description),
                             //Details: escape(data.Details),
                             Product: data.Product,
                             ProductVersion: data.ProductVersion,
                             Severity: data.Severity,
                             Platform: data.Platform,
                             PlatformVersion: data.PlatformVersion,
                             MachineId: data.MachineId,
                             Status: data.Status,
                             Type: data.Type,
                             AccountNumber: data.AccountNumber,
                             AccountName: data.AccountName,
                             CCEngineer: data.CCEngineer,
                             CCEngineerId: data.CCEngineerId,
                             Contact: data.Contact,
                             ContactId: data.ContactId,
                             EDBnumber: data.EDBnumber
                         },
                                         function (result) {
                                             var url = yourApp.Urls.ModifyDataUrl;
                                             WinId = window.open(url, '_blank');
                                             WinId.document.open();
                                             WinId.document.write(result);
                                             WinId.document.close();
                                             myTable.rows('.selected').deselect();
                                         });
                     }
                 },
                 enabled: false
             },
                 {
                     text: '@DPTnew.Localization.Resource.New',
                     className: 'new',
                     action: function () {
                         $.post(yourApp.Urls.CaseDataUrl, {
                             CaseId: null,
                             StrCreatedOn: null,
                             StrModifiedOn: null,
                             Description: null,
                             Details: null,
                             Product: null,
                             ProductVersion: null,
                             Severity: null,
                             Platform: null,
                             PlatformVersion: null,
                             MachineId: null,
                             Status: null,
                             Type: null,
                             AccountNumber: null,
                             AccountName: null,
                             CCEngineer: null,
                             CCEngineerId: null,
                             Contact: null,
                             ContactId: null,
                             EDBnumber: null
                         },
                                             function (result) {
                                                 var url = yourApp.Urls.CaseDataUrl;
                                                 WinId = window.open(url, '_blank');
                                                 WinId.document.open();
                                                 WinId.document.write(result);
                                                 WinId.document.close();
                                                 myTable.rows('.selected').deselect();
                                             });
                     },
                     enabled: "@ViewBag.UserNoCase.ToString().ToLower()" == "true"
                 },
        {
            text: '@DPTnew.Localization.Resource.Update',
            className: 'update',
            action: function () {
                if (myTable.rows('.selected').count() != 0) {
                    var data = myTable.rows('.selected').data()[0];
                    $.post(yourApp.Urls.CaseHistoryUrl, {
                        CaseId: data.CaseId,
                    },
                                    function (result) {
                                        var url = yourApp.Urls.CaseHistoryUrl;
                                        WinId = window.open(url, '_blank');
                                        WinId.document.open();
                                        WinId.document.write(result);
                                        WinId.document.close();
                                        myTable.rows('.selected').deselect();
                                    });
                }
            },
            enabled: false
        },
        {
            text: '@DPTnew.Localization.Resource.History',
            className: 'history',
            action: function () {
                if (myTable.rows('.selected').count() != 0) {
                    var data = myTable.rows('.selected').data()[0];
                    $.post(yourApp.Urls.GetCaseHistoryUrl, {
                        caseId: data.CaseId,
                    },
                                    function (result) {
                                        var url = yourApp.Urls.GetCaseHistoryUrl;
                                        WinId = window.open(url, '_blank');
                                        WinId.document.open();
                                        WinId.document.write(result);
                                        WinId.document.close();
                                        //myTable.rows('.selected').deselect();
                                    });
                }
            },
            enabled: false
        }
                ]
            });
            myTable.buttons().container().insertBefore('#dptcase_filter');

            myTable.on('select', function () {
                var caseRow = myTable.rows('.selected').data()[0];
                if (caseRow.Status.toLowerCase() !== "frozen" && "@ViewBag.UserRole.ToString().ToLower()" == "true")
                    myTable.buttons(['.modify']).enable(true);
                if (caseRow.Status.toLowerCase() !== "frozen")
                    myTable.buttons(['.update']).enable(true);
                myTable.buttons(['.history']).enable(true);
                myTable.buttons(['.new']).disable();
            });

            myTable.on('deselect', function () {
                myTable.buttons(['.modify']).disable();
                myTable.buttons(['.update']).disable();
                myTable.buttons(['.history']).disable();
                myTable.buttons(['.new']).enable(true);
            });

            myTable.on("draw", function () {
                var $body = $(myTable.table().body());
                $body.unhighlight();
                $body.highlight(myTable.search());
            });

            // Add event listener for opening and closing details
            $('#dptcase tbody').on('click', 'td.details-control', function () {

                var tr = $(this).closest('tr');
                var row = myTable.row(tr);
                var index = row.index();
                if (row.child.isShown()) {
                    // This row is already open - close it
                    row.child.hide();
                    tr.removeClass('shown');
                }
                else {
                    // Open this row
                    var data = row.data();
                    row.child(format(row.data())).show();
                    tr.addClass('shown');
                }
            });

            yadcf.init(myTable, [
            { column_number: 3, filter_default_label: "@DPTnew.Localization.Resource.Select", data: ["General Request", "Bug", "Wish"] },
            { column_number: 4, filter_default_label: "@DPTnew.Localization.Resource.Select", data: ["Open", "Working", "Waiting on R&D", "Waiting on Customer", "Closed", "Frozen"] },
            { column_number: 5, filter_default_label: "@DPTnew.Localization.Resource.Select", data: ["tomoki.miyamoto@t3-japan.co.jp", "hideki.kobayashi@t3-japan.co.jp", "fumiko.kasahara@t3-japan.co.jp", "michiyo.miyako@t3-japan.co.jp", "satomi.ono@t3-japan.co.jp", "giorgio.pirri@dptcorporate.com", "jacopo.azzi@dptcorporate.com", "intae.lee@t3-japan.co.jp"] },
            { column_number: 6, filter_default_label: "@DPTnew.Localization.Resource.Select", data: ["English", "Japanese", "Korean"] }
            ]);
        });

    </script>
}
<div style="width: 1000px">
    <table id="dptcase" class="display" cellspacing="0" width="100%">
        <thead>
            <tr>
                <th></th>
                <th>
                    @Html.DisplayNameFor(model => model.CaseId)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.Description)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.Type)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.Status)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.CCEngineer)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.Language)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.StrModifiedOn)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.AccountName)
                </th>
            </tr>
        </thead>
    </table>
</div>

