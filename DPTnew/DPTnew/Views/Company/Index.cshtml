@model DPTnew.Models.CompanyView


@{
    ViewBag.Title = "Companies";
}


@section Scripts {
    @*<script src="~/Scripts/Company/table_list.js"> </script>*@
    <link href="~/Content/buttons.dataTables.min.css" rel="stylesheet" />
    <link href="~/Content/jquery.dataTables.min.css" rel="stylesheet" />
    <script src="~/Scripts/jquery-1.12.3.min.js"></script>
    <script src="~/Scripts/jquery.dataTables.min.js"></script>
    <script src="~/Scripts/dataTables.buttons.min.js"></script>
    <script src="~/Scripts/buttons.flash.min.js"></script>
    <script src="~/Scripts/jszip.min.js"></script>
    <script src="~/Scripts/pdfmake.min.js"></script>
    <script src="~/Scripts/vfs_fonts.js"></script>
    <script src="~/Scripts/buttons.html5.min.js"></script>
    <script src="~/Scripts/buttons.print.min.js"></script>

    <script type="text/javascript">

        /* Formatting function for row details - modify as you need */
        function format(d) {

            // `d` is the original data object for the row
            return '<table cellpadding="5" cellspacing="0" border="0" width="100%" style="padding-left:50px;">' +
             '<tr>' +
                  '<td><b>Address:</b></td>' +
                  '<td>' + d.Address + '</td>' +

                 '<td><b>ZIP:</b></td>' +
                  '<td>' + d.ZIP + '</td>' +

              '</tr>' +
               '<tr>' +

                 '<td><b>City:</b></td>' +
                  '<td>' + d.City + '</td>' +

                  '<td><b>Province:</b></td>' +
                  '<td>' + d.Province + '</td>' +

                  '<td><b>Country:</b></td>' +
                  '<td>' + d.Country + '</td>' +
              '</tr>' +
                   '</table>';
        }



        $(document).ready(function () {
            var searchFilterHandler = function () {

                var api = this.api();
                api.$("td:not(.licenses,.details-control)").click(function () {
                    api.search(this.innerText).draw();
                    //api.columns(this.cellIndex).search( this.innerHTML ).draw();
                });
            };

            var myTable = $("#companies").DataTable({
                drawCallback: searchFilterHandler,
                initComplete: searchFilterHandler,
                serverSide: true,
                processing: true,
                dom: 'lBfrtip',
                buttons: [
                    'csv', 'excel', 'pdf'
                ],
                ajax: {
                    type: "POST",
                    url: "Company/Search"
                },
                columns: [
                {
                    "className": 'details-control',
                    "orderable": false,
                    "data": null,
                    "defaultContent": ''
                },
                { data: "AccountNumber", "className": 'no-dropdown' },
                { data: "AccountName", "className": 'no-dropdown' },
                { data: "AccountKind" },
                { data: "ShortStatus" },
                { data: "LastExp" },
                { data: "SalesRep" },
                 {
                     "className": 'licenses',
                     "orderable": false,
                     "data": null,
                     "defaultContent": '<button>Licenses</button>'
                 }
                ],
                //order: [[1, 'asc']],
                orderClasses: false,
                createdRow: function (row, data, index) {
                    if (data.AccountStatus != null) {
                        debugger
                        var sub = data.AccountStatus.substring(0, 1);
                        switch (data.AccountStatus.substring(0, 2)) {
                            case "02":
                                $(row).addClass('highlight_brown');
                                break;
                            case "04":
                                $(row).addClass('highlight_gray');
                                break;
                            case "05":
                                $(row).addClass('highlight_red');
                                break;
                            case "06":
                                $(row).addClass('highlight_orange');
                                break;
                        }
                    }
                },
            });

            //myTable.on("draw", function () {
            //    var $body = $(myTable.table().body());
            //    $body.unhighlight();
            //    $body.highlight(myTable.search());
            //});

            // Add event listener for opening licenses page
            $('#companies tbody').on('click', 'td.licenses', function () {

                var tr = $(this).closest('tr');
                var row = myTable.row(tr);
                var datarow = row.data();

                window.open("/Company/Licenses/" + datarow.AccountNumber, "_blank");
            })
            // Add event listener for opening and closing details
            $('#companies tbody').on('click', 'td.details-control', function () {

                var tr = $(this).closest('tr');
                var row = myTable.row(tr);
                var index = row.index();
                if (row.child.isShown()) {
                    // This row is already open - close it
                    row.child.hide();
                    tr.removeClass('shown');
                }
                else {
                    // Open this row
                    var data = row.data();
                    row.child(format(row.data())).show();
                    tr.addClass('shown');
                }
            });


            yadcf.init(myTable, [
      { column_number: 3, filter_default_label: "Select", data: ["customer", "partner", "educational"] },
      { column_number: 4, filter_default_label: "Select", data: ["Active Customer", "Partner", "Ex Customer", "Only Legacy", "Not Active Customer", "Not Active Customer OM"] },
      { column_number: 5, filter_default_label: "Select", data: ["j: next month", "e: > 1 year", "h: > 1 month", "g: > 3 months", "k: next 3 months", "m: even later", "c: > 3 years", "a: > 10 years", "i: last month", "b: > 5 years", "f: > 6 months", "d: > 2 years", "l: next year"] },
      { column_number: 6, filter_default_label: "Select", data: JSON.parse(atob("@ViewBag.SalesReps")) }]);

        });


    </script>
}

<div style="width: 1000px">

    <table id="companies" class="display" cellspacing="0" width="100%">
        <thead>
            <tr>
                <th></th>

                <th>
                    @Html.DisplayNameFor(model => model.AccountNumber)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.AccountName)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.AccountKind)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.ShortStatus)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.LastExp)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.SalesRep)
                </th>

                <th></th>

            </tr>
        </thead>
    </table>
</div>
