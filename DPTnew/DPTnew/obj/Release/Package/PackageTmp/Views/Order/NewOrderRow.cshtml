@model IEnumerable<DPTnew.Models.Order>

@{
    ViewBag.Title = "Orders";
}

@section Scripts {
    <link href="~/Content/jquery-ui.min.css" rel="stylesheet" />
    <script src="~/Scripts/jquery-ui.min.js"></script>
    <script type="text/javascript">
        var yourApp = yourApp || {};
        yourApp.Urls = yourApp.Urls || {};
        yourApp.Urls.baseUrl = '@Url.Content("~")';
        yourApp.Urls.GetInvoiceInfo = '@Url.Action("GetInvoiceInfo", "Order")';
        yourApp.Urls.GetProducts = '@Url.Action("GetProducts", "Order")';
        yourApp.Urls.GetLicenseIds = '@Url.Action("GetLicenseIds", "Order")';
        yourApp.Urls.GetLicenseInfo = '@Url.Action("GetLicenseInfo", "Order")';
        yourApp.Urls.GetPrice = '@Url.Action("GetPrice", "Order")';

        var companies = JSON.parse(atob('@ViewBag.Companies'));
        function submitform() {
            $(this).find('button[type="submit"]').attr('disabled', 'disabled');
            setTimeout(function () {
                $(this).find('button[type="submit"]').attr('disabled', 'disabled');
            }, 2000);
            if ($("#accountName-choice").val() == "" || $("#productName-choice").val() == "" || $("#licenseID-choice").val() == "") {
                var $psw = $("#msg");
                $psw.text("");
                $psw.text("Please fill out Account name, Product name and licenseID fields!");
                var pwdDialogConfig = {
                    modal: true,
                    width: 400,
                    height: 250,
                    buttons: {
                        OK: function () {
                            $(this).dialog("close");
                            //location.reload();
                        }
                    }
                };
                $("#sysmsg-dialog").dialog(pwdDialogConfig);
            }
            else
                $.post("/Order/Insert", {
                    idxx: $("input[name=idxx]").val(),
                    OrderNumber: $("input[name=orderNumber]").val(),
                    AccountName: $("#accountName-choice").val(),
                    SalesRep: $("input[name=salesRep]").val(),
                    Invoicer: $("input[name=invoicer]").val(),
                    InvoicedName: $("input[name=invoicedName]").val(),
                    InvoicedNumber: $("input[name=invoicedNumber]").val(),
                    ProductName: $("#productName-choice").val(),
                    ArticleDetail: $("#articleDetail-choice").val(),
                    LicenseID: $("#licenseID-choice").val(),
                    StartDate: $("input[name=startDate]").val(),
                    EndDate: $("input[name=endDate]").val(),
                    LicenseType: $("input[name=licenseType]").val(),
                    LineType: $("#lineType-choice").val(),
                    Quantity: $("input[name=quantity]").val(),
                    Ordered: $("input[name=ordered]").val(),
                    Orderdate: $("input[name=orderDate]").val(),
                    PO_Number: $("#item_PO_Number").val(),
                    InvoiceNumber: $("input[name=invoiceNumber]").val(),
                    Invoicedate: $("input[name=invoiceDate]").val(),
                    NewOldAccount: $("input[name=newOldAccount]").val(),
                    NewRenewal: $("#newRenewal-choice").val(),
                    Currency: $("input[name=currency]").val(),
                    EURO_PriceList: $("input[name=euroPriceList]").val(),
                    JPY_PriceList: $("input[name=jpyPriceList]").val(),
                    Note: $("#item_Note").val()
                },
                function (result) {
                    if (result.split(" ").length == 4) {
                        $("input[name=orderNumber]").empty();
                        $("input[name=orderNumber]").val(result.split(" ")[2]);
                        $("input[name=idxx]").empty();
                        $("input[name=idxx]").val(result.split(" ")[3]);
                    }
                    var $psw = $("#msg");
                    $psw.text("");
                    $psw.text(result);
                    var pwdDialogConfig = {
                        modal: true,
                        width: 400,
                        height: result ? 250 : "auto",
                        buttons: {
                            OK: function () {
                                $(this).dialog("close");
                                //location.reload();
                            }
                        }
                    };
                    $("#sysmsg-dialog").dialog(pwdDialogConfig);
                });
        }

        $(document).ready(function () {
            if ($("#articleDetail-choice").val() != "asf")
                $("#articleDetail-choice").append("<option value='asf'>asf</option>");
            if ($("#articleDetail-choice").val() != "qsf")
                $("#articleDetail-choice").append("<option value='qsf'>qsf</option>");
            if ($("#articleDetail-choice").val() != "plss")
                $("#articleDetail-choice").append("<option value='plss'>plss</option>");
            if ($("#articleDetail-choice").val() != "pl")
                $("#articleDetail-choice").append("<option value='pl'>pl</option>");
            if ($("#articleDetail-choice").val() != "chw")
                $("#articleDetail-choice").append("<option value='chw'>chw</option>");
            if ($("#articleDetail-choice").val() != "cvu")
                $("#articleDetail-choice").append("<option value='cvu'>cvu</option>");

            if ($("#lineType-choice").val() != "standard")
                $("#lineType-choice").append("<option value='standard' selected>standard</option>");
            if ($("#lineType-choice").val() != "activation")
                $("#lineType-choice").append("<option value='activation'>activation</option>");
            if ($("#lineType-choice").val() != "freeOfCharge")
                $("#lineType-choice").append("<option value='freeOfCharge'>freeOfCharge</option>");

            if ($("#newRenewal-choice").val() != "renewal")
                $("#newRenewal-choice").append("<option value='renewal' selected>renewal</option>");
            if ($("#newRenewal-choice").val() != "new")
                $("#newRenewal-choice").append("<option value='new'>new</option>");

            var price = 0;
            if ($("input[name=currency]").val() == "eur")
                price = $("input[name=euroPriceList]").val();
            else
                price = $("input[name=jpyPriceList]").val();
            var ord = $("input[name=ordered]").val();
            if (price !== 0 && ord !== 0) {
                var dis = (1 - (ord / price)) * 100;
                $("input[name=discount]").val(dis);
            }

            //if ($("input[name=startDate]").val() == "0001-01-01" || $("input[name=endDate]").val() == "0001-01-01" ||
            //    $("input[name=orderDate]").val() == "0001-01-01" || $("input[name=invoiceDate]").val() == "0001-01-01") {
            //    var now = new Date();
            //    var month = (now.getMonth() + 1);
            //    var day = now.getDate();
            //    if (month < 10)
            //        month = "0" + month;
            //    if (day < 10)
            //        day = "0" + day;
            //    var today = now.getFullYear() + '-' + month + '-' + day;
            //    $("input[name=startDate]").val(today);
            //    $("input[name=endDate]").val(today);
            //    $("input[name=orderDate]").val(today);
            //    $("input[name=invoiceDate]").val(today);
            //}

            $("input[name=orderDate]").change(function () {
                var ordDate = new Date($("input[name=orderDate]").val());
                var lastDateofTheMonth = new Date(ordDate.getFullYear(), ((ordDate.getMonth() + 1) % 12), 1);
                $("input[name=invoiceDate]").val(lastDateofTheMonth.toISOString().substring(0,10));
            });

            for (var i = 0; i < companies.length; i++) {
                $("#accountName-choice").append('<option value="' + companies[i].split("\"")[0].substring(0, companies[i].length - 1) + '">' + companies[i] + '</option>');
            }

            $("#accountName-choice").change(function () {
                $("#productName-choice").empty();
                $.post(yourApp.Urls.GetProducts, { companyName: $("#accountName-choice").val() },
                     function (result) {
                         $("#productName-choice").empty();
                         $("#productName-choice").append("<option value='" + "" + "'>" + "" + "</option>");
                         for (var i = 0; i < result.length; i++) {
                             $("#productName-choice").append("<option value='" + result[i] + "'>" + result[i] + "</option>");
                         }
                     });
                $.post(yourApp.Urls.GetInvoiceInfo, { companyName: $("#accountName-choice").val() },
                     function (result) {
                         $("input[name=salesRep]").empty();
                         $("input[name=salesRep]").val(result.SalesRep);
                         $("input[name=invoicer]").empty();
                         $("input[name=invoicer]").val(result.Invoicer);
                         $("input[name=invoicedName]").empty();
                         $("input[name=invoicedName]").val(result.InvoicedName);
                         $("input[name=invoicedNumber]").empty();
                         $("input[name=invoicedNumber]").val(result.InvoicedNumber);
                         $("input[name=newOldAccount]").empty();
                         $("input[name=newOldAccount]").val(result.NewOldAccount);
                         $("input[name=currency]").empty();
                         $("input[name=currency]").val(result.Currency);
                     });
            });

            $("#productName-choice").change(function () {
                $("#licenseID-choice").empty();
                $.post(yourApp.Urls.GetLicenseIds, { companyName: $("#accountName-choice").val(), productName: $("#productName-choice").val() },
                     function (result) {
                         $("#licenseID-choice").empty();
                         $("#licenseID-choice").append("<option value='" + "" + "'>" + "" + "</option>");
                         for (var i = 0; i < result.length; i++) {
                             $("#licenseID-choice").append("<option value='" + result[i].LicenseID + "'>" + result[i].LicenseID + " - \"" + result[i].MachineID + "\" - " + result[i].MED + "</option>");
                         }
                     });
                if ($("#articleDetail-choice").val() !== "") {
                    $.post(yourApp.Urls.GetPrice, { productName: $("#productName-choice").val(), articleDetail: $("#articleDetail-choice").val(), licenseType: $("input[name=licenseType]").val(), quantity: $("input[name=quantity]").val() },
                         function (result) {
                             $("input[name=euroPriceList]").empty();
                             $("input[name=euroPriceList]").val(result.split("_")[0]);
                             $("input[name=jpyPriceList]").empty();
                             $("input[name=jpyPriceList]").val(result.split("_")[1]);
                         });
                }
            });

            $("#articleDetail-choice").change(function () {
                if ($("#productName-choice").val() !== "") {
                    $.post(yourApp.Urls.GetPrice, { productName: $("#productName-choice").val(), articleDetail: $("#articleDetail-choice").val(), licenseType: $("input[name=licenseType]").val(), quantity: $("input[name=quantity]").val() },
                         function (result) {
                             $("input[name=euroPriceList]").empty();
                             $("input[name=euroPriceList]").val(result.split("_")[0]);
                             $("input[name=jpyPriceList]").empty();
                             $("input[name=jpyPriceList]").val(result.split("_")[1]);
                         });
                }
            });

            $("input[name=licenseType]").change(function () {
                if ($("#productName-choice").val() !== "" && $("#articleDetail-choice").val() !== "") {
                    $.post(yourApp.Urls.GetPrice, { productName: $("#productName-choice").val(), articleDetail: $("#articleDetail-choice").val(), licenseType: $("input[name=licenseType]").val(), quantity: $("input[name=quantity]").val() },
                         function (result) {
                             $("input[name=euroPriceList]").empty();
                             $("input[name=euroPriceList]").val(result.split("_")[0]);
                             $("input[name=jpyPriceList]").empty();
                             $("input[name=jpyPriceList]").val(result.split("_")[1]);
                         });
                }
            });

            $("#licenseID-choice").change(function () {
                $("#licenseType-choice").empty();
                $.post(yourApp.Urls.GetLicenseInfo, { licenseId: $("#licenseID-choice").val() },
                     function (result) {
                         $("input[name=licenseType]").empty();
                         $("input[name=licenseType]").val(result.LicenseType);
                         $("input[name=quantity]").empty();
                         $("input[name=quantity]").val(result.Quantity);
                         $("input[name=startDate]").empty();
                         $("input[name=startDate]").val(result.PwdCode);
                         $("input[name=endDate]").empty();
                         $("input[name=endDate]").val(result.Ancestor);
                         $("input[name=licenseType]").change();
                     });
            });

            $("input[name=ordered]").change(function () {
                $("input[name=discount]").empty();
                var price = 0;
                if ($("input[name=currency]").val() == "eur")
                    price = $("input[name=euroPriceList]").val();
                else
                    price = $("input[name=jpyPriceList]").val();
                var ord = $("input[name=ordered]").val();
                if (price !== 0 && ord !== 0) {
                    var dis = (1 - (ord / price)) * 100;
                    $("input[name=discount]").val(dis);
                }
            });

        });
    </script>
}

@foreach (var item in Model)
{
    <div class="editor-label" style="font-size: 1.2em;">
        @Html.DisplayNameFor(model => model.AccountName)
    </div>
    <div class="editor-field">
        <select name="accountName" id="accountName-choice">
            <option selected value="@Html.DisplayFor(modelItem => item.AccountName)">@Html.DisplayFor(modelItem => item.AccountName)</option>
        </select>
    </div>
    <div class="editor-label" style="font-size: 1.2em;">
        @Html.DisplayNameFor(model => model.PO_Number)
    </div>
    <div class="editor-field">
        @Html.TextAreaFor(modelItem => item.PO_Number, new { @cols = 20, @rows = 1 })
    </div>
}
<table id="dptorder" class="display" cellspacing="0" width="100%">
    <thead>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>@Html.DisplayNameFor(model => model.OrderNumber)</td>
                <td>
                    <input type="text" name="orderNumber" value="@Html.DisplayFor(modelItem => item.OrderNumber)">
                </td>
                <td>@Html.DisplayNameFor(model => model.idxx)</td>
                <td>
                    <input type="number" name="idxx" min="0" value="@Html.DisplayFor(modelItem => item.idxx)" readonly>
                </td>
            </tr>
            <tr>
                <td>@Html.DisplayNameFor(model => model.SalesRep)</td>
                <td>
                    <input type="text" name="salesRep" value="@Html.DisplayFor(modelItem => item.SalesRep)" readonly>
                </td>
                <td>@Html.DisplayNameFor(model => model.Invoicer)</td>
                <td>
                    <input type="text" name="invoicer" value="@Html.DisplayFor(modelItem => item.Invoicer)" readonly>
                </td>
            </tr>
            <tr>
                <td>@Html.DisplayNameFor(model => model.InvoicedName)</td>
                <td>
                    <input type="text" name="invoicedName" value="@Html.DisplayFor(modelItem => item.InvoicedName)" readonly>
                </td>
                <td>@Html.DisplayNameFor(model => model.InvoicedNumber)</td>
                <td>
                    <input type="text" name="invoicedNumber" value="@Html.DisplayFor(modelItem => item.InvoicedNumber)" readonly>
                </td>
            </tr>
            <tr>
                <td>@Html.DisplayNameFor(model => model.StrOrderDate)</td>
                <td>
                    <input type="date" name="orderDate" value="@Html.DisplayFor(modelItem => item.StrOrderDate)">
                </td>
                <td>@Html.DisplayNameFor(model => model.NewOldAccount)</td>
                <td>
                    <input type="text" name="newOldAccount" value="@Html.DisplayFor(modelItem => item.NewOldAccount)" readonly>
                </td>
            </tr>
            <tr>
                <td>@Html.DisplayNameFor(model => model.StrInvoiceDate)</td>
                <td>
                    <input type="date" name="invoiceDate" value="@Html.DisplayFor(modelItem => item.StrInvoiceDate)" readonly>
                </td>
                <td>@Html.DisplayNameFor(model => model.InvoiceNumber)</td>
                <td>
                    <input type="text" name="invoiceNumber" value="@Html.DisplayFor(modelItem => item.InvoiceNumber)" readonly>
                </td>
            </tr>
            <tr>
                <td>@Html.DisplayNameFor(model => model.Currency)</td>
                <td>
                    <input type="text" name="currency" value="@Html.DisplayFor(modelItem => item.Currency)" readonly>
                </td>
                <td></td>
                <td></td>
            </tr>
        }
    </tbody>
</table>
<div>
    <text>
        <font color="gray">
            ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        </font>
    </text>
</div>
<table id="dptorder2" class="display" cellspacing="0" width="100%">
    <thead>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>@Html.DisplayNameFor(model => model.ProductName)</td>
                <td>
                    <select name="productName" id="productName-choice">
                        <option selected value="@Html.DisplayFor(modelItem => item.ProductName)">@Html.DisplayFor(modelItem => item.ProductName)</option>
                    </select>
                </td>
                <td>@Html.DisplayNameFor(model => model.ArticleDetail)</td>
                <td>
                    <select name="articleDetail" id="articleDetail-choice">
                        <option selected value="@Html.DisplayFor(modelItem => item.ArticleDetail)">@Html.DisplayFor(modelItem => item.ArticleDetail)</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>@Html.DisplayNameFor(model => model.LicenseID)</td>
                <td>
                    <select name="licenseID" id="licenseID-choice">
                        <option selected value="@Html.DisplayFor(modelItem => item.LicenseID)">@Html.DisplayFor(modelItem => item.LicenseID)</option>
                    </select>
                </td>
                <td>@Html.DisplayNameFor(model => model.LineType)</td>
                <td>
                    <select name="lineType" id="lineType-choice">
                        <option selected value="@Html.DisplayFor(modelItem => item.LineType)">@Html.DisplayFor(modelItem => item.LineType)</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>@Html.DisplayNameFor(model => model.LicenseType)</td>
                <td>
                    <input type="text" name="licenseType" value="@Html.DisplayFor(modelItem => item.LicenseType)" readonly>
                </td>
                <td>@Html.DisplayNameFor(model => model.Quantity)</td>
                <td>
                    <input type="number" name="quantity" min="1" value="@Html.DisplayFor(modelItem => item.Quantity)" readonly>
                </td>
            </tr>
            <tr>
                <td>@Html.DisplayNameFor(model => model.StrStartDate)</td>
                <td>
                    <input type="date" name="startDate" value="@Html.DisplayFor(modelItem => item.StrStartDate)">
                </td>
                <td>@Html.DisplayNameFor(model => model.StrEndDate)</td>
                <td>
                    <input type="date" name="endDate" value="@Html.DisplayFor(modelItem => item.StrEndDate)">
                </td>
            </tr>
            <tr>
                <td>@Html.DisplayNameFor(model => model.NewRenewal)</td>
                <td>
                    <select name="newRenewal" id="newRenewal-choice">
                        <option selected value="@Html.DisplayFor(modelItem => item.NewRenewal)">@Html.DisplayFor(modelItem => item.NewRenewal)</option>
                    </select>
                </td>
                <td>@Html.DisplayNameFor(model => model.Ordered)</td>
                <td>
                    <input type="number" name="ordered" min="0" value="@Html.DisplayFor(modelItem => item.Ordered)">
                </td>
            </tr>
            <tr>
                <td>@Html.DisplayNameFor(model => model.EURO_PriceList)</td>
                <td>
                    <input type="number" name="euroPriceList" min="0" value="@Html.DisplayFor(modelItem => item.EURO_PriceList)" readonly>
                </td>
                <td>@Html.DisplayNameFor(model => model.JPY_PriceList)</td>
                <td>
                    <input type="number" name="jpyPriceList" min="0" value="@Html.DisplayFor(modelItem => item.JPY_PriceList)" readonly>
                </td>
            </tr>
            <tr>
                <td>Discount</td>
                <td>
                    <input type="number" name="discount" min="0" value="0" readonly>
                </td>
                <td></td>
                <td></td>
            </tr>
        }
    </tbody>
</table>
@foreach (var item in Model)
{
    <div class="editor-label" style="font-size: 1.2em;">
        @Html.DisplayNameFor(model => model.Note)
    </div>
    <div class="editor-field">
        @Html.TextAreaFor(modelItem => item.Note, new { @cols = 20, @rows = 1 })
    </div>
}
<p>
    <a href="javascript: submitform()"><input type="submit" value="Submit" /></a>
    <a href="javascript:window.open('','_self').close();"><input type="submit" value="Close" /></a>
</p>
<div id="sysmsg-dialog" title="System message" style="display:none;">
    <strong style="position:absolute; margin-top:20px;" id="msg"></strong>
</div>
